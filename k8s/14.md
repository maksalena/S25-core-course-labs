# Kubernetes StatefulSet

## StatefulSet Exploration and Optimization

### Retrieving StatefulSet and Related Resources

This command displays detailed information about running pods, StatefulSets, services, and PVCs, helping you monitor the current status of your Kubernetes cluster.

```shell
kubectl get po,sts,svc,pvc
NAME                                       READY   STATUS      RESTARTS      AGE
pod/python-app-python-854646957c-96nrx     1/1     Running     3 (9d ago)    23d
pod/python-app-python-854646957c-jdtcc     1/1     Running     3 (9d ago)    23d
pod/python-app-python-854646957c-xt5ph     1/1     Running     3 (9d ago)    23d
pod/python-deployment-cf645b767-4r8jm      1/1     Running     4 (9d ago)    30d
pod/python-deployment-cf645b767-7j4hx      1/1     Running     4 (9d ago)    30d
pod/python-deployment-cf645b767-ksgct      1/1     Running     4 (9d ago)    30d
pod/python-postinstall-hook                0/1     Completed   0             23d
pod/vault-0                                1/1     Running     2 (43s ago)   16d
pod/vault-agent-injector-dbfc5cd77-m8ffs   0/1     Running     2 (9d ago)    16d

NAME                     READY   AGE
statefulset.apps/vault   1/1     16d

NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python                 LoadBalancer   10.99.169.216    <pending>     8080:31152/TCP      30d
service/kubernetes                 ClusterIP      10.96.0.1        <none>        443/TCP             30d
service/python-app-python          LoadBalancer   10.96.69.197     <pending>     8080:32276/TCP      23d
service/python-service             LoadBalancer   10.111.209.63    <pending>     8080:31584/TCP      30d
service/vault                      ClusterIP      10.100.132.232   <none>        8200/TCP,8201/TCP   16d
service/vault-agent-injector-svc   ClusterIP      10.99.241.170    <none>        443/TCP             16d
service/vault-internal             ClusterIP      None             <none>        8200/TCP,8201/TCP   16d
```

### Checking Minikube Services

This command provides the URLs where the service is accessible, both on the internal network and externally through Minikube tunneling.

```shell
minikube service python-app-python
|-----------|-------------------|-------------|---------------------------|
| NAMESPACE |       NAME        | TARGET PORT |            URL            |
|-----------|-------------------|-------------|---------------------------|
| default   | python-app-python | http/8080   | http://192.168.49.2:32276 |
|-----------|-------------------|-------------|---------------------------|
üèÉ  Starting tunnel for service python-app-python.
|-----------|-------------------|-------------|------------------------|
| NAMESPACE |       NAME        | TARGET PORT |          URL           |
|-----------|-------------------|-------------|------------------------|
| default   | python-app-python |             | http://127.0.0.1:50606 |
|-----------|-------------------|-------------|------------------------|
üéâ  Opening service default/python-app-python in default browser...
```

### Inspecting the StatefulSet

This command provides insights into pod specifications, update strategies, environment variables, volume claims, and events related to the StatefulSet.

```shell
kubectl describe sts python
Name:               python-app-python
Namespace:          default
CreationTimestamp:  Sat, 15 Mar 2025 17:26:56 +0300
Selector:           app.kubernetes.io/instance=python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=0.1.0
Labels:             app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
Annotations:        meta.helm.sh/release-name: python
                    meta.helm.sh/release-namespace: default
Replicas:           3 desired | 3 total
Update Strategy:    RollingUpdate
  Partition:        0
Pods Status:        3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:           app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-config.txt: internal/data/server/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   python-app:
    Image:      maksalena/server-app:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASSWORD:     <set to the key 'password' in secret 'credentials'>              Optional: false
      CONFIG_MAP_VAR:  <set to the key 'env-var' of config map 'app-python-configmap'>  Optional: false
      RELEASE_NAME:    python
      SLEEP_TIME:      5
    Mounts:
      /app/config_map from config-volume (rw)
      /app/data from visits-data (rw)
  Volumes:
   config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      app-python-configmap
    Optional:  false
   visits-data:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  500Mi
Volume Claims:
  Name:          visits-data
  StorageClass:  
  Labels:        <none>
  Annotations:   <none>
  Capacity:      1Gi
  Access Modes:  [ReadWriteOnce]
Events:
  Type    Reason            Age    From                    Message
  ----    ------            ----   ----                    -------
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Claim visits-data-python-app-python-0 Pod python-app-python-0 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Pod python-app-python-0 in StatefulSet python-app-python successful
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Claim visits-data-python-app-python-1 Pod python-app-python-1 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Pod python-app-python-1 in StatefulSet python-app-python successful
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Claim visits-data-python-app-python-2 Pod python-app-python-2 in StatefulSet python-app-python success
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Pod python-app-python-2 in StatefulSet python-app-python successful
```

### Checking the Visits File

I accessed my app from different tabs and modes in your browser. Then, I accessed the visits file:

```shell
kubectl exec pod/python-python-app-0 -- cat data/visits.txt
4
kubectl exec pod/python-python-app-1 -- cat data/visits.txt
1
kubectl exec pod/python-python-app-2 -- cat data/visits.txt
22 
```

### StatefulSet Data Distribution

Each pod within a StatefulSet maintains its own dedicated persistent volume, meaning data storage remains isolated per pod. Since the service balancer does not evenly distribute traffic among all pods, visit counts can differ across them. This results in variations in how often each pod is accessed and the data it stores.

### Ensuring StatefulSet Stability

StatefulSets inherently provide stable identities and consistent network addresses for their pods, eliminating the need for explicit ordering controls. Since each pod retains its state and unique name even when rescheduled on different nodes, applications can continue operating seamlessly without requiring a strict launch sequence. This ensures reliability and persistence for stateful workloads.

### Validating Persistent Storage

```shell
kubectl delete pod python-python-app-0
pod "python-python-app-0" deleted

kubectl get pods
NAME             READY   STATUS    RESTARTS   AGE
python-python-app-0   1/1     Running   0          15s
python-python-app-1   1/1     Running   0          2m35s
python-python-app-2   1/1     Running   0          2m35s

kubectl exec pod/python-python-app-0 -- cat data/visits.txt
4
```

The visit count remained consistent even after the pod was deleted and recreated, confirming that the persistent volume is functioning as intended.

### Service DNS Resolution

```shell
kubectl exec pod/python-python-app-0 -- nslookup python-python-app-1.app-stateful.stateful-lab.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   python-python-app-1.app-stateful.stateful-lab.svc.cluster.local
Address: 10.244.0.35
```

The headless service enables DNS resolution for individual pods, facilitating direct communication between them through stable network identities.

### Enabling Parallel Pod Management

To allow all pods in a StatefulSet to launch or terminate in parallel, update your statefulset.yaml configuration by adding:

```shell
spec:
  podManagementPolicy: Parallel
```

### Exploring StatefulSet Update Strategies

StatefulSets support various update strategies that cater to different operational needs. Here are the most common ones

* Rolling Deployment - Updates pods one at a time, ensuring zero downtime.

* Recreate Deployment - Deletes all existing pods before creating new ones, causing downtime but ensuring a clean update.

* Ramped Slow Rollout - Gradually replaces pods while maintaining system stability.

* Best-Effort Controlled Rollout - Allows a set percentage of unavailable pods during deployment for faster rollouts.

* Blue/Green Deployment - Creates a duplicate environment to switch over once validated.

* Canary Deployment - Releases a new version to a small user segment before expanding.

* Shadow Deployment - Tests a new version in parallel without affecting real users.

* A/B Testing - Runs multiple versions simultaneously to analyze user response.

For more details, refer to <https://spot.io/resources/kubernetes-autoscaling/5-kubernetes-deployment-strategies-roll-out-like-the-pros/>.
