# Securely Managing Kubernetes Secrets with HashiCorp Vault

## Managing Kubernetes Secrets

Kubernetes Secrets provide a way to manage sensitive information, such as passwords, OAuth tokens, and SSH keys, without exposing them in plain text within configuration files.

### Creating a Kubernetes Secret

To create a Kubernetes Secret containing a username and password, use the following command:

```shell
kubectl create secret generic db-user-pass     --from-literal=username=admin     --from-literal=password='12345678'
secret/db-user-pass created
```

### Verifying the Secret

To confirm that the secret was created successfully, list all secrets in the cluster:

```shell
kubectl get secrets
NAME                           TYPE                 DATA   AGE
db-user-pass                   Opaque               2      13s
sh.helm.release.v1.python.v1   helm.sh/release.v1   1      7d1h
```

### Decoding Kubernetes Secrets

Kubernetes Secrets are base64-encoded. To retrieve and decode them, use the following commands:

```shell
kubectl get secret db-user-pass -o jsonpath='{.data.password}' | base64 --decode
12345678
kubectl get secret db-user-pass -o jsonpath='{.data.username}' | base64 --decode
admin
```

## Managing Secrets with Helm

Helm simplifies the management of Kubernetes applications, including secrets, by providing templating and version control.

### Installing the Helm Secrets Plugin

* First, install the Helm Secrets plugin:

```shell
helm plugin install https://github.com/zendesk/helm-secrets
```

* Generate a new GPG key for encrypting your secrets:

```shell
gpg --gen-key
```

* To edit secrets securely:

```shell
EDITOR='nano' sops -p PUB_KEY secrets.yaml
```

* To view the stored secrets:

```shell
helm secrets view secrets.yaml 
password: abc12345678
```

### Using Helm to Manage Kubernetes Secrets

1. Create a `secrets.yaml` file inside the Helm templates folder.

2. Define a Secret object within the YAML file.

3. Update the Deployment manifest to reference the secret under `spec.template.spec.containers.env`.

4. Deploy the Helm chart with the secret:

```shell
helm secrets install python-app ./python-app/ -n default -f ./secrets.yaml
```

### Verifying Secrets Inside a Pod

To check that the secret is accessible inside a running pod:

```shell
kubectl get po
NAME                                 READY   STATUS      RESTARTS       AGE
python-app-python-854646957c-96nrx   1/1     Running     0              33s
python-app-python-854646957c-jdtcc   1/1     Running     0              33s
python-app-python-854646957c-xt5ph   1/1     Running     0              33s
python-deployment-cf645b767-4r8jm    1/1     Running     0              33s
python-deployment-cf645b767-7j4hx    1/1     Running     0              33s
python-deployment-cf645b767-ksgct    1/1     Running     0              33s

kubectl exec python-app-python-854646957c-96nrx -- printenv | grep MY_PASS
MY_PASSWORD=abc12345678
```

## Managing Secrets with HashiCorp Vault

HashiCorp Vault provides a secure way to store and access secrets with fine-grained access controls.

* Installing Vault in Kubernetes

```shell
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

### Configuring Vault for Kubernetes

* set secret, enable auth, write policy for service account

```shell
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/server/config password="abc12345678"
======= Secret Path =======
internal/data/server/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-02-25T12:37:01.393144096Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/server/config
======= Secret Path =======
internal/data/server/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-02-25T12:37:01.393144096Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    abc12345678
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
> kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/server/config" {
> capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
> bound_service_account_names=internal-app \
> bound_service_account_namespaces=default \
> policies=internal-app \
> ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

* After deploying Vault, verify the running pods:

```shell
kubectl get po
NAME                                   READY   STATUS      RESTARTS       AGE
...
vault-0                                1/1     Running     0              2m7s
vault-agent-injector-dbfc5cd77-m8ffs   1/1     Running     0              2m7s
```

* To confirm that secrets are injected into the application:

```shell
kubectl exec -it python-app-python-854646957c-96nrx -- bash
Defaulted container "app-python" out of: python-app, vault-agent, vault-agent-init (init)
user@python-app-python-854646957c-96nrx:/app$ cat /vault/secrets/config.txt
data: map[password:abc12345678]
metadata: map[created_time:2025-02-25T10:00:54.152958675Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
user@python-app-python-854646957c-96nrx:/app$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay         469G  137G  309G  31% /
tmpfs            64M     0   64M   0% /dev
/dev/nvme0n1p5  469G  137G  309G  31% /etc/hosts
tmpfs            31G  4.0K   31G   1% /vault/secrets
shm              64M     0   64M   0% /dev/shm
tmpfs            31G   12K   31G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs            16G     0   16G   0% /proc/asound
tmpfs            16G     0   16G   0% /proc/acpi
tmpfs            16G     0   16G   0% /proc/scsi
tmpfs            16G     0   16G   0% /sys/firmware
```

## Verifying Environment Variables in Kubernetes

To confirm environment variables are properly set, run:

```shell
kubectl exec  python-app-python-854646957c-96nrx  -- printenv | grep -e 'RELEASE_NAME' -e 'MY_PASS' -e 'SLEEP_TIME'
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
RELEASE_NAME=python
SLEEP_TIME=5
MY_PASSWORD=abc123
```
